# Call Detail Records

Generating call detail records (CDRs) is a standard requirement for SIP servers.  The drachio-server process generates the following types of CDRs:
* a **call attempt record** is generated when a call attempt (i.e., INVITE) is either received or generated by the server
* a **call start record** is generated when a call is connected (i.e., 200 OK either sent or received), and
* a **call stop record** is generated when a call ends or a non-successful INVITE transaction completes.

It follows from the above that a successful completed call will generate three CDRs (call attempt, call start, call stop), while a failed INVITE will only generate two CDRs (call attempt, call end).

An application registers to receive CDRs by registering for events as illustrated below.

```js
const Srf = require('drachtio-srf');
const srf = new Srf();
const config = require('config');

srf.connect(config.get('drachtio'))
  .on('error', (err) => console.error(`Error connecting: ${err}`));


// register to receive CDRs
srf.on('cdr:attempt', (source, time, msg) => {
  console.log(`got attempt record from ${source} at ${time}: msg.get('Call-Id')`) ;

  // got attempt record from network at 20:05:58.130582: 671261870@42.55.72.99

});

srf.on('cdr:start', (source, time, role, msg) => {
  console.log(`got start record from ${source} at ${time} with role ${role}: msg.get('Call-Id')`) ;

  // got start record from network at 20:05:59.781505 with role uas: 671261870@42.55.72.99
});

srf.on('cdr:stop', (source, time, reason, msg) => {
  console.log(`got stop record from ${source} at ${time} with reason ${reason}: msg.get('Call-Id')`) ;

  // got stop record from network at 20:06:22.695850 with reason normal-release: 671261870@42.55.72.99
});
```

> Note that it is completely possible to have one specialized application connecting and receiving CDRs, while other applications are performing the call control logic.  This ability to separate CDR generation from application logic is often desirable in larger, more complex systems.

The cdr events provide the following information elements:
* `source`: either 'network' or 'application', depending on whether the INVITE was received by or sent from the drachtio server, respectively.
* `time`: the UTC time that the request was sent or received
* `role`: the role that the drachtio server is playing with regards to this INVITE request: 
  + 'uas': the server is receiving the INVITE as a UAS
  + 'uac': the server is generating the INVITE as a UAC
  + 'proxy-uac': the server is forwarding an INVITE as a proxy
  + 'proxy-uas': the server is receiving an INVITE as a proxy
* `reason`: the termination reason for the call
  + 'call-rejected': the INVITE was rejected with a non-success final status
  + 'call-canceled': the INVITE was canceled by the sender before answer
  + 'normal-release': the call was connected and later released normally by one side or the other
  + 'session-expired': the call was connected and later torn down by the drachtio server because the session expired
* `msg`:
  + for 'cdr:attempt', the INVITE request
  + for 'cdr:start', the 200 OK
  + for 'cdr:stop', the final non-success response (if reason is 'call-rejected'), otherwise the BYE request taht was sent or received to terminate the Dialog.

  Further information about the call, such as calling and called party numbers, can be retrieved from the `msg` parameter using the [properties and methods of the SIP Message object](#sip-messages).

  > Note: an application that wishes to receive CDR events must establish an inbound connection to the drachtio server, since CDR events are not currently sent over outbound connections.



